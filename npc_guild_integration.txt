# NPC-Guild Integration System Documentation

## Overview

The NPC-Guild Integration System creates a dynamic, organic relationship between individual NPCs and guild organizations within the Age of Scribes simulation. This system ensures that guild membership feels realistic and meaningful, with NPCs making decisions based on their personality, motivations, circumstances, and changing loyalties over time.

## Core Philosophy

### Emergent Membership
- NPCs evaluate guild membership based on personal motivations, not arbitrary assignments
- Career compatibility drives initial interest, but personality determines commitment
- Guild membership is a living relationship that evolves over time

### No Player Favoritism
- Player characters receive no automatic acceptance or special treatment
- Guild membership must be earned through proper gameplay mechanics
- Guilds have their own standards and politics that affect all applicants equally

### Dynamic Loyalty
- Guild loyalty fluctuates based on personal experiences, guild performance, and external events
- Members can become disloyal, defect, or even conspire against their guild
- High-performing guilds naturally attract and retain better members

## System Architecture

### NPCProfile Extensions

#### New Attributes
```python
guild_membership: Optional[str]     # ID of local guild chapter or None
guild_rank: Optional[str]          # "apprentice", "journeyman", "master", "guildmaster"
guild_loyalty_score: float         # -1.0 (disloyal) to 1.0 (devoted)
guild_history: list[dict]          # Historical record of all guild involvement
```

#### Guild History Structure
Each entry in `guild_history` contains:
- `event`: Type of guild event (joined, promoted, expelled, resigned)
- `guild_id`: ID of the guild involved
- `guild_name`: Name of guild for historical reference
- `rank`: Rank at time of event
- `timestamp`: When the event occurred
- `circumstances`: Additional context (motivation_score, reason, etc.)

### LocalGuild Extensions

#### Member Management
```python
members: List[str]                 # List of NPC IDs who are members
rank_structure: List[str]          # Guild hierarchy structure
member_cap: int                    # Maximum supported members
skill_threshold: Dict[str, float]   # Requirements for membership
```

#### New Methods
- `accept_member(npc_id: str) -> bool`: Process new member applications
- `evaluate_member_promotion(npc, loyalty, reputation, current_rank) -> str`: Check promotion eligibility
- `remove_member(npc_id: str, reason: str) -> None`: Handle member departures
- `evaluate_member_requirements(reputation, loyalty, wealth) -> bool`: Check joining requirements

## Core Mechanics

### Guild Affiliation Evaluation

The system evaluates NPCs daily through `evaluate_guild_affiliation()`:

#### For Unaffiliated NPCs:
1. **Career Compatibility Check**: Determines if NPC's career is guild-eligible
2. **Guild Availability**: Finds appropriate guilds in the settlement
3. **Motivation Calculation**: Evaluates personal desire to join based on:
   - Personality traits (loyal, pragmatic vs rebellious, freedom-loving)
   - Belief system (authority, freedom, law values)
   - Economic motivations (guild wealth, personal needs)
   - Social factors (loneliness, community desire)
4. **Guild Selection**: Chooses best-fitting guild based on:
   - Guild reputation and stability
   - Faction alignment compatibility
   - Guild size preferences
5. **Requirements Check**: Guild evaluates NPC against standards
6. **Membership Processing**: If accepted, establishes initial rank and loyalty

#### For Current Members:
1. **Promotion Evaluation**: Checks eligibility for rank advancement
2. **Loyalty Tracking**: Adjusts loyalty based on:
   - Guild performance and stability
   - Personal reputation changes
   - Personality-based drift
   - External conflicts and events
3. **Departure Assessment**: Evaluates potential resignation or expulsion
4. **Status Updates**: Processes any changes to membership status

### Career-Guild Mapping

The system uses career types to determine guild eligibility:

| Career Type | Eligible Guild Type | Notes |
|-------------|-------------------|-------|
| Merchant | Merchants Guild | Trade-focused organizations |
| Craftsman | Craftsmen Guild | Artisan and manufacturing guilds |
| Scholar | Scholars Guild | Academic and research institutions |
| Guard | Warriors Guild | Military and security organizations |
| Thief | Thieves Guild | Criminal organizations (hidden) |
| Mage | Mages Guild | Magical practitioners |
| Farmer | None | Typically independent |
| Laborer | None | General workforce |
| Noble | None | Above guild systems |
| Clergy | None | Religious organizations separate |

### Promotion System

Guild ranks follow a standard progression:
1. **Apprentice**: Entry level, learning basic skills
2. **Journeyman**: Competent practitioner, full privileges
3. **Master**: Senior member, can train others
4. **Guildmaster**: Leadership position, policy decisions

#### Promotion Requirements:
- **Loyalty Threshold**: Minimum loyalty to guild
- **Reputation Requirement**: Standing in community
- **Time Served**: Minimum duration at current rank
- **Guild Capacity**: Available positions at higher ranks

### Loyalty Dynamics

Guild loyalty (`guild_loyalty_score`) ranges from -1.0 to 1.0:

#### Positive Influences:
- Successful guild operations (+0.01 daily)
- Personal promotions (+0.2 instant)
- Guild prosperity and stability (+0.01 daily)
- Naturally loyal personality traits (+0.005 daily)

#### Negative Influences:
- Guild conflicts and instability (-0.02 to -0.05 daily)
- Personal reputation problems (-0.01 daily)
- Rebellious personality traits (-0.01 daily)
- Leadership failures and scandals (event-based)

#### Loyalty Thresholds:
- **1.0 to 0.7**: Devoted member, unlikely to leave
- **0.6 to 0.3**: Committed member, stable
- **0.2 to -0.2**: Neutral member, may be swayed
- **-0.3 to -0.6**: Disloyal member, considering departure
- **-0.7 to -1.0**: Actively disloyal, likely to defect or conspire

## Player Character Integration

### Application Process

Players must navigate the same requirements as NPCs, with several interaction methods:

#### Formal Application
- Standard process through guild leadership
- Requires meeting all stated requirements
- Most common and socially acceptable method
- Success based on reputation, wealth, and career compatibility

#### Informal Networks
- Using social connections and recommendations
- Can bypass some formal requirements
- Requires existing relationships with guild members
- Political approach that may have future obligations

#### Bribery
- Offering payments or favors for admission
- Can overcome reputation or skill deficiencies
- Reduces initial loyalty and may create future problems
- Risk of offense and permanent rejection

#### Coercion
- Using threats or intimidation for admission
- High-risk approach that can backfire dramatically
- Requires significant reputation or power to be effective
- Creates hostile relationships within guild

### Player Advantages

Players do NOT receive automatic benefits, but have unique capabilities:
- **Agency**: Can actively work to meet requirements
- **Networking**: Can build relationships to improve chances
- **Wealth**: Can potentially overcome some barriers through resources
- **Reputation**: Can build standing through actions and choices

## Integration Points

### Career Transition Engine

The guild system integrates with career changes:
- **Job Availability**: Guild membership affects job access
- **Priority Systems**: Members get preference for related work
- **Exclusive Opportunities**: Some positions only available to guild members
- **Conflict Resolution**: Rival guild politics can block certain opportunities

### Economic System

Guild membership impacts economic activities:
- **Trade Efficiency**: Guild members get better rates
- **Market Access**: Some markets restricted to guild members
- **Caravan Protection**: Guild connections provide safety
- **Credit Systems**: Guild standing affects lending and contracts

### Faction Relationships

Guild politics intersect with faction dynamics:
- **Aligned Guilds**: Share faction allegiances and conflicts
- **Neutral Guilds**: May work with any faction for profit
- **Rival Factions**: Guild conflicts can mirror larger political struggles
- **Dual Loyalties**: NPCs may have conflicting guild and faction obligations

### Settlement Effects

Guild activities impact their home settlements:
- **Economic Influence**: Powerful guilds affect local trade
- **Political Power**: Guild leadership may influence governance
- **Social Structure**: Guilds create class and professional distinctions
- **Conflict Spillover**: Guild wars can disrupt settlement peace

## Advanced Features

### Guild Conspiracies

The system supports organic conspiracy formation:

#### Types of Conspiracies:
- **Internal Takeover**: Members plotting to change leadership
- **Hostile Takeover**: Outsiders attempting to seize control
- **Splinter Formation**: Dissatisfied members forming new guilds
- **Rival Destruction**: Coordinated attacks on competing guilds

#### Success Factors:
- **Leadership Quality**: Cunning and diplomatic conspirators
- **Guild Stability**: Weak guilds more vulnerable
- **Member Loyalty**: Low loyalty enables internal conspiracies
- **External Support**: Faction backing or rival guild assistance

#### Potential Outcomes:
- Leadership changes and policy reforms
- Mass resignations and guild splits
- New guild formation and market competition
- Exposed conspiracies and member purges

### Multi-Guild Dynamics

NPCs can be involved with multiple guild systems:
- **Sequential Membership**: Moving between guilds over time
- **Competing Loyalties**: Torn between guild and faction obligations
- **Secret Memberships**: Hidden affiliations (especially thieves)
- **Professional Networks**: Informal relationships across guild boundaries

## Implementation Guidelines

### Daily Processing

The system runs daily evaluations:
1. Process all NPC guild affiliations in settlement
2. Update loyalty scores based on recent events
3. Evaluate promotion and departure candidates
4. Handle any conspiracy or conflict developments
5. Record all changes for narrative generation

### Performance Considerations

- **Batch Processing**: Evaluate multiple NPCs simultaneously
- **Change Tracking**: Only process NPCs with significant status changes
- **Event Filtering**: Focus on meaningful guild interactions
- **Memory Management**: Archive old guild history entries

### Narrative Integration

All guild changes generate narrative events:
- **Membership Changes**: Joining, leaving, promotions
- **Loyalty Shifts**: Major changes in devotion
- **Conflict Developments**: Conspiracies, rivalries, alliances
- **Economic Impacts**: Job access, trade changes, opportunities

## Testing and Validation

### Key Test Scenarios

1. **Career Transitions**: NPCs changing professions and guild eligibility
2. **Guild Conflicts**: How member loyalty responds to external threats
3. **Player Applications**: All application methods and their consequences
4. **Conspiracy Formation**: Organic development of guild plots
5. **Economic Integration**: Job access and trade preference systems

### Balance Considerations

- **Membership Rates**: Ensure realistic guild participation levels
- **Loyalty Stability**: Prevent excessive churn while allowing meaningful change
- **Player Equity**: Maintain challenge without unfair disadvantage
- **Narrative Weight**: Balance mechanical effects with story impact

## Future Extensions

### Planned Enhancements

- **Guild Specializations**: More detailed professional focuses
- **Regional Networks**: Cross-settlement guild chapters
- **Political Integration**: Guild influence on settlement governance
- **Economic Monopolies**: Guild control over specific markets
- **Cultural Traditions**: Guild-specific customs and ceremonies

### Integration Opportunities

- **Marriage System**: Guild membership affecting courtship
- **Education System**: Apprenticeship and skill development
- **Reputation System**: Guild standing affecting social status
- **Quest System**: Guild-specific missions and opportunities
- **Conflict Resolution**: Guild mediation of disputes

## Conclusion

The NPC-Guild Integration System creates a living, breathing professional landscape where guild membership is earned, maintained, and potentially lost through meaningful gameplay. By treating guilds as dynamic organizations with their own politics, standards, and conflicts, the system generates organic stories of professional ambition, loyalty, betrayal, and community building.

NPCs become more than simple profession labels—they become individuals navigating complex social and economic structures, making decisions that affect both their personal advancement and the broader community's development. Players must engage with these same systems authentically, creating opportunities for meaningful choice and consequence in their professional lives. 